"""
HOTARU - Internationalisation (FR / EN).
Français par défaut.
"""

import streamlit as st

SESSION_LANG = "lang"
DEFAULT_LANG = "fr"

# Traductions principales (navigation, header, workspace, JSON-LD Analysis)
TRANSLATIONS = {
    "fr": {
        "nav.home": "Accueil",
        "nav.audit": "Audit",
        "nav.jsonld": "JSON-LD",
        "nav.eco": "Eco-Score",
        "nav.audit_geo": "Audit GEO",
        "nav.authority": "Authority Score",
        "nav.scraping": "Scraping",
        "nav.master": "Master",
        "nav.jsonld_analysis": "Analyse JSON-LD",
        "workspace.label": "Projets (Workspace)",
        "workspace.help": "Choisissez le projet / workspace pour filtrer les audits.",
        "workspace.new": "Nouveau",
        "workspace.create": "+ Créer Nouveau",
        "workspace.uncategorized": "Non classé",
        "login": "CONNEXION",
        "logout": "DÉCONNEXION",
        "login.error": "Identifiants invalides.",
        # JSON-LD Analysis
        "jsonld.title": "ANALYSE JSON-LD",
        "jsonld.tagline": "Détection des types de pages par structure DOM et pattern d'URL. Clustering intelligent (seuil 85%).",
        "jsonld.tab_new": "Nouvelle analyse",
        "jsonld.tab_load": "Charger depuis Sheets",
        "jsonld.no_saved": "Aucune donnée enregistrée pour votre compte. Lancez une analyse puis enregistrez dans Google Sheets.",
        "jsonld.select_site": "Sélectionner un site enregistré",
        "jsonld.load_btn": "CHARGER DEPUIS GOOGLE SHEETS",
        "jsonld.no_models": "Aucun modèle trouvé pour ce site et workspace.",
        "jsonld.data_loaded": "Données chargées.",
        "jsonld.url_label": "URL du site à analyser",
        "jsonld.url_help": "Page d'accueil ou point d'entrée du site.",
        "jsonld.pages_label": "Nombre de pages à crawler",
        "jsonld.pages_help": "~1-2 s/page (mode requests). Clustering < 30 s pour 500 pages.",
        "jsonld.launch": "LANCER L'ANALYSE",
        "jsonld.clear": "EFFACER LES RÉSULTATS",
        "jsonld.enter_url": "Veuillez entrer une URL.",
        "jsonld.crawl_error": "Erreur crawl",
        "jsonld.check_url": "Vérifiez l'URL, la connexion réseau et l'accessibilité du site.",
        "jsonld.no_pages": "Aucune page récupérée. Vérifiez l'URL et réessayez.",
        "jsonld.crawl_logs": "Logs du crawl",
        "jsonld.spinner_cluster": "Clustering des pages...",
        "jsonld.spinner_naming": "Nommage Mistral — cluster",
        "jsonld.mistral_fail": "Mistral : {n} cluster(s) sans nom (timeout ou API occupée). Réessayez.",
        "jsonld.mistral_missing": "Clé API Mistral manquante. Configurez st.secrets['mistral']['api_key'].",
        "jsonld.overview": "Vue d'ensemble",
        "jsonld.site": "Site",
        "jsonld.pages_analyzed": "Pages analysées",
        "jsonld.models_detected": "Modèles détectés",
        "jsonld.no_clusters": "Aucun cluster détecté. Le site peut avoir une structure très homogène.",
        "jsonld.tip_clusters": "Astuce : beaucoup de clusters peuvent indiquer une structure variée ou un seuil ajustable.",
        "jsonld.run_new": "Lancez une nouvelle analyse avec une URL différente ou plus de pages.",
        "jsonld.graph_title": "Graphe interactif des clusters",
        "jsonld.graph_caption": "Cliquez sur un cluster (nœud coloré) pour afficher les détails dans le panneau. Cliquez sur une URL pour l'ouvrir. Sinon, utilisez le menu déroulant.",
        "jsonld.select_cluster": "Sélectionner un cluster",
        "jsonld.cluster_details": "Détails du cluster",
        "jsonld.model": "Modèle",
        "jsonld.schema": "Schema.org",
        "jsonld.pattern": "Pattern",
        "jsonld.pages": "Pages",
        "jsonld.gen_title": "Génération automatique du JSON-LD optimisé :",
        "jsonld.gen_caption": "Mistral AI analyse la structure et génère un JSON-LD Schema.org complet avec tous les champs recommandés.",
        "jsonld.generate": "GÉNÉRER",
        "jsonld.gen_help": "Génère le JSON-LD optimisé pour ce cluster via Mistral AI",
        "jsonld.mistral_spinner": "Mistral génère le JSON-LD optimisé...",
        "jsonld.gen_success": "JSON-LD optimisé généré !",
        "jsonld.gen_fail": "Échec de la génération. Réessayez ou vérifiez les logs Mistral.",
        "jsonld.no_crawl": "Résultats du crawl non disponibles (analyse chargée depuis Sheets). Lancez une nouvelle analyse.",
        "jsonld.current": "JSON-LD actuel",
        "jsonld.no_existing": "Aucun JSON-LD détecté sur ces pages.",
        "jsonld.optimized": "JSON-LD optimisé",
        "jsonld.download": "Télécharger JSON-LD",
        "jsonld.click_generate": "Cliquez sur 'GÉNÉRER' pour créer le JSON-LD optimisé.",
        "jsonld.dom_structure": "Structure DOM",
        "jsonld.not_available": "Non disponible.",
        "jsonld.existing": "JSON-LD existant",
        "jsonld.no_jsonld": "Aucun JSON-LD détecté.",
        "jsonld.sample_urls": "URLs exemples",
        "jsonld.tab_urls": "URLs",
        "jsonld.and_more": "... et {n} de plus.",
        "jsonld.optimized_yes": "JSON-LD optimisé généré",
        "jsonld.optimized_no": "JSON-LD optimisé non généré",
        "jsonld.url_pattern": "Pattern d'URL",
        "jsonld.load_from": "Charger depuis Google Sheets",
        "jsonld.saved_site": "Site enregistré",
        "jsonld.save_to": "Enregistrer dans Google Sheets",
        "jsonld.save_btn": "ENREGISTRER DANS GOOGLE SHEETS",
        "jsonld.save_success": "Modèles JSON-LD enregistrés dans l'onglet 'jsonld' du Google Sheet.",
        "jsonld.save_fail": "Échec de l'enregistrement. Vérifiez la config GCP (secrets) et l'URL du Sheet.",
        "jsonld.download_json": "Télécharger JSON",
        "jsonld.download_full": "Télécharger le JSON complet",
        "jsonld.tab_graph": "GRAPHE",
        "jsonld.tab_table": "TABLEAU",
        "jsonld.tab_export": "EXPORT",
        "jsonld.tab_logs": "Logs",
    },
    "en": {
        "nav.home": "Home",
        "nav.audit": "Audit",
        "nav.jsonld": "JSON-LD",
        "nav.eco": "Eco-Score",
        "nav.audit_geo": "GEO Audit",
        "nav.authority": "Authority Score",
        "nav.scraping": "Scraping",
        "nav.master": "Master",
        "nav.jsonld_analysis": "JSON-LD Analysis",
        "workspace.label": "Projects (Workspace)",
        "workspace.help": "Choose the project / workspace to filter audits.",
        "workspace.new": "New",
        "workspace.create": "+ Create New",
        "workspace.uncategorized": "Uncategorized",
        "login": "LOGIN",
        "logout": "LOGOUT",
        "login.error": "Invalid credentials.",
        # JSON-LD Analysis
        "jsonld.title": "JSON-LD ANALYSIS",
        "jsonld.tagline": "Page type detection by DOM structure and URL pattern. Intelligent clustering (85% threshold).",
        "jsonld.tab_new": "New analysis",
        "jsonld.tab_load": "Load from Sheets",
        "jsonld.no_saved": "No saved data for your account. Run an analysis then save to Google Sheets.",
        "jsonld.select_site": "Select a saved site",
        "jsonld.load_btn": "LOAD FROM GOOGLE SHEETS",
        "jsonld.no_models": "No models found for this site and workspace.",
        "jsonld.data_loaded": "Data loaded.",
        "jsonld.url_label": "Site URL to analyze",
        "jsonld.url_help": "Homepage or entry point URL of the site.",
        "jsonld.pages_label": "Number of pages to crawl",
        "jsonld.pages_help": "Est. ~1-2 s/page (requests mode). Clustering < 30 s for 500 pages.",
        "jsonld.launch": "LAUNCH ANALYSIS",
        "jsonld.clear": "CLEAR RESULTS",
        "jsonld.enter_url": "Please enter a URL.",
        "jsonld.crawl_error": "Crawl error",
        "jsonld.check_url": "Check URL, network connection and site accessibility.",
        "jsonld.no_pages": "No pages retrieved. Check URL and try again.",
        "jsonld.crawl_logs": "Crawl logs",
        "jsonld.spinner_cluster": "Clustering pages...",
        "jsonld.spinner_naming": "Mistral naming — cluster",
        "jsonld.mistral_fail": "Mistral: {n} cluster(s) without name (timeout or API busy). Retry.",
        "jsonld.mistral_missing": "Mistral API key missing. Configure st.secrets['mistral']['api_key'].",
        "jsonld.overview": "Overview",
        "jsonld.site": "Site",
        "jsonld.pages_analyzed": "Pages analyzed",
        "jsonld.models_detected": "Models detected",
        "jsonld.no_clusters": "No clusters detected. Site may have very homogeneous structure.",
        "jsonld.tip_clusters": "Tip: many clusters may indicate varied site structure or adjustable similarity threshold.",
        "jsonld.run_new": "Run a new analysis with a different URL or more pages.",
        "jsonld.graph_title": "Interactive cluster graph",
        "jsonld.graph_caption": "Click a cluster (colored node) to show details in the panel. Click a URL to open in a new tab. If the graph click doesn't work, use the dropdown.",
        "jsonld.select_cluster": "Select a cluster",
        "jsonld.cluster_details": "Cluster details",
        "jsonld.model": "Model",
        "jsonld.schema": "Schema.org",
        "jsonld.pattern": "Pattern",
        "jsonld.pages": "Pages",
        "jsonld.gen_title": "Automatic optimized JSON-LD generation:",
        "jsonld.gen_caption": "Mistral AI analyzes the structure and generates a complete Schema.org JSON-LD with all recommended fields.",
        "jsonld.generate": "GENERATE",
        "jsonld.gen_help": "Generate optimized JSON-LD for this cluster via Mistral AI",
        "jsonld.mistral_spinner": "Mistral generating optimized JSON-LD...",
        "jsonld.gen_success": "Optimized JSON-LD generated!",
        "jsonld.gen_fail": "Generation failed. Retry or check Mistral logs.",
        "jsonld.no_crawl": "Crawl results not available (analysis loaded from Sheets). Run a new analysis.",
        "jsonld.current": "Current JSON-LD",
        "jsonld.no_existing": "No JSON-LD detected on these pages.",
        "jsonld.optimized": "Optimized JSON-LD",
        "jsonld.download": "Download JSON-LD",
        "jsonld.click_generate": "Click 'GENERATE' to create the optimized JSON-LD.",
        "jsonld.dom_structure": "DOM structure",
        "jsonld.not_available": "Not available.",
        "jsonld.existing": "Existing JSON-LD",
        "jsonld.no_jsonld": "No JSON-LD detected.",
        "jsonld.sample_urls": "Sample URLs",
        "jsonld.tab_urls": "URLs",
        "jsonld.and_more": "... and {n} more.",
        "jsonld.optimized_yes": "Optimized JSON-LD generated",
        "jsonld.optimized_no": "Optimized JSON-LD not generated",
        "jsonld.url_pattern": "URL pattern",
        "jsonld.load_from": "Load from Google Sheets",
        "jsonld.saved_site": "Saved site",
        "jsonld.save_to": "Save to Google Sheets",
        "jsonld.save_btn": "SAVE TO GOOGLE SHEETS",
        "jsonld.save_success": "JSON-LD models saved to 'jsonld' tab in Google Sheet.",
        "jsonld.save_fail": "Save failed. Check GCP config (secrets) and Sheet URL.",
        "jsonld.download_json": "Download JSON",
        "jsonld.download_full": "Download full JSON",
        "jsonld.tab_graph": "GRAPH",
        "jsonld.tab_table": "TABLE",
        "jsonld.tab_export": "EXPORT",
        "jsonld.tab_logs": "Logs",
    },
}


def get_current_lang():
    """Retourne la langue active (fr ou en). Français par défaut."""
    return st.session_state.get(SESSION_LANG, DEFAULT_LANG)


def set_lang(lang: str):
    """Définit la langue (fr ou en)."""
    if lang in ("fr", "en"):
        st.session_state[SESSION_LANG] = lang


def t(key: str, **kwargs) -> str:
    """Retourne la chaîne traduite pour la clé donnée. kwargs pour formater {key} dans la chaîne."""
    lang = get_current_lang()
    d = TRANSLATIONS.get(lang, TRANSLATIONS[DEFAULT_LANG])
    s = d.get(key, key)
    if kwargs:
        try:
            s = s.format(**kwargs)
        except KeyError:
            pass
    return s
