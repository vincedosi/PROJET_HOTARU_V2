# CLAUDE.md - HOTARU V2 Development Guide

## Project Overview

HOTARU (蛍, "firefly") is a SaaS application for SEO/GEO (Generative Engine Optimization) auditing with AI-powered analysis. It scans website structure, detects URL patterns, clusters pages semantically using Mistral AI, and generates optimization recommendations for discovery by generative AI models.

**Version**: 2.4.0
**Language**: Python 3.x
**Framework**: Streamlit
**AI Backend**: Mistral AI (mistral-tiny model)
**Database**: Google Sheets (with zlib compression for JSON data)

## Quick Start

```bash
pip install -r requirements.txt
streamlit run app.py
```

Requires `.streamlit/secrets.toml` with GCP service account credentials, Google Sheets URL, and Mistral API key configured in the UI.

## Project Structure

```
PROJET_HOTARU_V2/
├── app.py                           # Main entry point, SaaS navigation, CSS injection
├── requirements.txt                 # Python dependencies
├── template.json                    # JSON-LD schema template (150+ placeholders)
├── core/                            # Core backend modules
│   ├── auth.py                      # Google Sheets authentication, login/registration
│   ├── database.py                  # Audit CRUD, zlib compression for storage
│   ├── scraping.py                  # SmartScraper: crawling, pattern detection, sampling
│   └── ai_clustering.py            # Mistral AI integration for cluster renaming
├── modules/                         # UI modules (Streamlit pages)
│   ├── home.py                      # Home/guide page
│   ├── audit_geo.py                 # Main audit interface
│   ├── dashboard.py                 # Dashboard/overview
│   ├── settings.py                  # User settings, API vault
│   ├── geo_scoring.py              # GEO scoring engine (8 criteria)
│   ├── reports.py                   # Report generation
│   ├── entity_forge.py             # Entity/master data management
│   ├── render_audit_geo_modified.py # Alternative audit renderer
│   └── __init__.py
├── engine/                          # Data processing & template engine
│   ├── master_handler.py           # MasterData dataclass (150+ fields)
│   ├── dynamic_handler.py          # DynamicData for AI field predictions
│   ├── template_builder.py         # JSON-LD placeholder replacement engine
│   └── __init__.py
├── assets/                          # Static assets
│   ├── logo.png                     # HOTARU logo
│   └── styles.css                   # Zen design CSS
└── templates/                       # Data templates
    └── jsonld_MAXIMAL_final.json   # Comprehensive JSON-LD schema
```

## Architecture

### Three-Tier Data Model

1. **Master Data** (fixed, long-lived): Organization identity, legal IDs (SIREN, SIRET, LEI, DUNS), logos, contact. Stored in Google Sheets, shared across all pages.
2. **Dynamic Data** (context-specific, AI-predicted): Article headlines, product specs, event details. Generated by Mistral AI based on sector type (A-Q categories).
3. **Page Data** (crawled, variable): URLs, titles, H1s, meta descriptions, response times. Collected by SmartScraper.

### Key Data Flow

```
User Input (URL)
  → SmartScraper (pattern detection + smart sampling)
  → Mistral AI (cluster renaming)
  → GEOScorer (8-point scoring)
  → PyVis Visualization (interactive graph)
  → Save to Google Sheets (compressed JSON)
```

### Smart Sampling Pattern

When a URL cluster has more than 5 pages, only 3 representative samples are analyzed. Scores are inferred for remaining pages. This reduces API calls from O(n) to O(1) per pattern.

### Template Substitution

`template.json` contains JSON-LD with `{{MASTER_*}}`, `{{DYN_*}}`, and `{{PAGE_*}}` placeholders. `engine/template_builder.py` merges Master + Dynamic + Page data to produce final JSON-LD per page.

## Code Conventions

### Language

- Code is in **English** (variable names, function names, comments)
- UI strings, documentation, and user-facing text are in **French**
- The existing `claude.md` contains the original project vision in French

### Style

- No linter or formatter is currently configured
- Follow existing code style: snake_case for functions/variables, PascalCase for classes
- Use Python dataclasses for data structures (see `engine/master_handler.py`, `engine/dynamic_handler.py`)
- Streamlit session state (`st.session_state`) is used extensively for cross-page state

### Design System ("Zen Japonais")

- **Background**: Pure white `#FFFFFF`
- **Text**: Pure black `#000000`
- **Accent**: Gold `#FFD700` (used sparingly for active elements)
- **Score colors**: Green `#22C55E` (70+), Orange `#F97316` (40-69), Red `#EF4444` (<40)
- **Font**: Inter / system sans-serif
- **Philosophy**: "What doesn't serve the purpose disappears" -- radical minimalism

### Error Handling Pattern

```python
try:
    result = external_api.call()
except Exception:
    result = load_from_session()  # fallback to cached
```

Used for Google Sheets auth, Mistral API, and Wikidata/INSEE lookups.

## Key Dependencies

| Package | Purpose |
|---------|---------|
| `streamlit` | Web framework |
| `pyvis` + `networkx` | Graph visualization |
| `requests` + `beautifulsoup4` + `lxml` | Web scraping |
| `pandas` | Data analysis |
| `gspread` + `google-auth` | Google Sheets API |
| `scikit-learn` | ML utilities (clustering) |
| `selenium` + `webdriver-manager` | Headless browser for JS-rendered sites |
| `python-dotenv` | Environment variable management |

## Security Notes

- **Never commit** `.streamlit/secrets.toml`, `service_account.json`, `credentials.json`, or `.env` files
- Mistral API key is stored in `st.session_state` only (not persisted to disk)
- GCP credentials are loaded via Streamlit secrets mechanism
- User passwords are hashed with SHA-256 before storage
- Data isolation: users only see their own audits (filtered by `user_email`)

## Testing

No test framework is currently set up. The `.gitignore` includes `.pytest_cache/` and `.coverage` for future use.

## Common Tasks

### Adding a new UI module

1. Create a new file in `modules/`
2. Define a main rendering function (e.g., `render_my_module()`)
3. Register the module in `app.py` sidebar navigation
4. Follow the Zen design system for UI components

### Adding a new data field to MasterData

1. Add the field to the `MasterData` dataclass in `engine/master_handler.py`
2. Add corresponding `{{MASTER_*}}` placeholder to `template.json`
3. Update `engine/template_builder.py` if custom mapping logic is needed

### Modifying the scoring system

The GEO scoring engine lives in `modules/geo_scoring.py` with 8 evaluation criteria. Each criterion produces a 0-100 score contributing to an overall weighted average.
